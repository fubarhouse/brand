<?php

require_once 'lib/form_add.inc';
require_once 'lib/form_delete.inc';
require_once 'lib/form_edit.inc';
require_once 'lib/form_settings.inc';
require_once 'lib/form_view.inc';

/**
 * Get the Brand machine name for the current entity/path.
 *
 * @return array
 *   An array of machine names associated
 *   to the current entity or path.
 */
function brand_get_machine_name() : array {
  $results = array();
  $weight = 20;
  $output = array();
  if (path_is_admin(current_path())) {
    return array();
  }
  $brands = new Brands(NULL, TRUE);
  foreach ($brands::$Brands as $Brand) {

    if ($node = menu_get_object()) {
      $nid = (int)$node->nid;

      // Book.
      if (module_exists('book')) {
        if (isset($node->book['bid'])) {
          if ((int)$node->book['bid'] === (int)$Brand->bid) {
            $results[$Brand->machine_name] = $Brand->machine_name;
          }
        }

        // Nodes.
        if (module_exists('node')) {
          $delimiter = preg_split('/\s+/', $Brand->path_visibility);

          foreach ($delimiter as $node_target) {

            // Look for "node/xxx" in the path_visibility field:
            if (FALSE !== strpos($node_target, "node/{$nid}", 0)) {
              $results[$Brand->machine_name] = $Brand->machine_name;
            }

            // Check if the current node alias is the node target.
            elseif ($node_target === current_path()) {
              $results[$Brand->machine_name] = $Brand->machine_name;
            }

            // Check if the current node path matches the node target.
            elseif (drupal_match_path(current_path(), $node_target)) {
              $results[$Brand->machine_name] = $Brand->machine_name;
            }

            // Check if the current node alias matches the node target.
            elseif (drupal_match_path(drupal_get_path_alias(), $node_target)) {
              $results[$Brand->machine_name] = $Brand->machine_name;
            }
          }
        }
      }

      // Taxonomy.
      if (module_exists('taxonomy')) {
        foreach ((array)field_info_instances('node', $node->type) as $field_name => $info) {
          foreach ((array)field_get_items('node', $node, $field_name) as $item) {
            if (is_array($item) && !empty($item['tid']) && (int)$Brand->tid === (int)$item['tid']) {
              $results[$Brand->machine_name] = $Brand->machine_name;
            }
          }
        }
      }
    }

    // Paths.
    $delimiter = preg_split('/\s+/', $Brand->path_visibility);
    foreach ($delimiter as $path_target) {
      $path_target = trim($path_target);
      if (!empty(trim($path_target))) {
        if (isset($_GET['destination']) && drupal_match_path($_GET['destination'], $path_target)) {
          $results[$Brand->machine_name] = $Brand->machine_name;
        } elseif (isset($_GET['q']) && drupal_match_path($_GET['q'], $path_target)) {
          $results[$Brand->machine_name] = $Brand->machine_name;
        }
      }
    }
  }

  ksort($results);
  return $results;
}

/**
 * Implements hook_custom_theme().
 *
 * @inheritdoc
 */
function brand_custom_theme() {
  $default_theme = variable_get('theme_default', NULL);
  $theme = variable_get('theme_default', NULL);
  $machine_names = brand_get_machine_name();
  $machine_name_count = 0;
  $weight = 20;
  foreach ($machine_names as $machine_name) {
    $brand = new Brand($machine_name);
    if ($brand->Check() === TRUE) {
      if (NULL !== $brand::$Brand->theme && $brand::$Brand->theme !== '' && $brand::$Brand->theme !== 'none') {
        $machine_name_count++;
        if ((int) $brand::$Brand->weight < $weight) {
          $b = $brand::$Brand;
          $theme = $brand::$Brand->theme;
          $weight = $brand::$Brand->weight;
          $mname = $brand::$Brand->machine_name;
        }
      }
    }
  }
  if ($machine_name_count > 1 && user_access('brand visibility')) {
    $mnames = implode($machine_names, ', ');
    drupal_set_message("Multiple Brands have detected for use, the current brand in use uses the machine name '{$mname}'.<br />It was selected from [{$mnames}] by sorting the weight first, and then by alphabetical sorting.<br />If this is intentional, you can ignore this message. ", 'warning', FALSE);
  }
  // Let's double check that we're allowed to use the theme.
  $restriction = variable_get('brand_disable_checking', 0);
  if ((int) $restriction === 0) {
    $allowed_themes = brand_get_allowed_themes();
    foreach ($allowed_themes as $allowed_theme) {
      if ($allowed_theme === $theme) {
        return $theme;
      }
    }
    return $default_theme;
  }
  return $theme;
}

/**
 * Implements hook_menu().
 *
 * @inheritdoc
 */
function brand_menu() {
  $items = array();

  $Brands = new Brands(NULL, TRUE);
  foreach ($Brands::$Brands as $brand) {
    $items["admin/config/user-interface/brands/{$brand->machine_name}/"] = array(
      'title' => (string) $brand->title,
      'description' => "The main Brand page for the {$brand->machine_name} Brand.",
      'type' => MENU_NORMAL_ITEM,
      'access callback' => 'user_access',
      'access arguments' => array('brand visibility'),
    );
  }

  $items['admin/config/user-interface/brands/'] = array(
    'title' => 'Brands',
    'description' => 'A summary of all the latest entries of Brands',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['admin/config/user-interface/brands/add'] = array(
    'title' => 'New Brand',
    'description' => 'The form to create a new brand',
    'type' => MENU_LOCAL_ACTION,
    'page callback' => array('drupal_get_form'),
    'page arguments' => array('brand_add_form'),
    'access callback' => 'user_access',
    'access arguments' => array('brand creation'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  $items['admin/config/user-interface/brands/%/add'] = array(
    'title' => 'Add',
    'type' => MENU_LOCAL_ACTION,
    'description' => 'New entry',
    'page callback' => array('drupal_get_form'),
    'page arguments' => array('brand_edit_form'),
    'access callback' => 'user_access',
    'access arguments' => array('brand creation'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  $items['admin/config/user-interface/brands/%/delete'] = array(
    'title' => 'Delete',
    'type' => MENU_LOCAL_ACTION,
    'page callback' => array('drupal_get_form'),
    'page arguments' => array('brand_delete_form'),
    'access callback' => 'user_access',
    'access arguments' => array('brand removal'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  $items['admin/config/user-interface/brands/%/%'] = array(
    'title' => 'View a brand entry',
    'description' => '',
    'type' => MENU_NORMAL_ITEM,
    'access callback' => 'user_access',
    'access arguments' => array('brand visibility'),
    'page callback' => array('drupal_get_form'),
    'page arguments' => array('brand_view_form'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  $items['admin/config/user-interface/brands/%/%/delete'] = array(
    'title' => 'Delete',
    'description' => 'Remove an entry from a brand.',
    'type' => MENU_NORMAL_ITEM,
    'access callback' => 'user_access',
    'access arguments' => array('brand removal'),
    'page callback' => array('drupal_get_form'),
    'page arguments' => array('brand_delete_form'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  $items['admin/config/user-interface/brands/settings'] = array(
    'title' => 'Settings',
    'description' => '',
    'type' => MENU_LOCAL_TASK,
    'page callback' => array('drupal_get_form'),
    'page arguments' => array('brand_admin_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('brand settings'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  return $items;
}

/**
 * Implements hook_permission().
 *
 * @inheritdoc
 */
function brand_permission() {
  return array(
    'brand settings' => array(
      'title' => t('access and modify brand settings.'),
      'description' => t('View and modify the Brand settings form.'),
    ),
    'brand creation' => array(
      'title' => t('create new brands and brand entries'),
      'description' => t('Access and submit forms which add information into the Brand module table.'),
    ),
    'brand removal' => array(
      'title' => t('remove brands and brand entries'),
      'description' => t('Access and submit forms which remove information from the Brand module table.'),
    ),
    'brand visibility' => array(
      'title' => t('view brands and brand entries'),
      'description' => t('Access and submit forms which add information into the Brand module table.'),
    ),
  );
}

/**
 * Get a list of themes configured for use.
 *
 * Themes can be controlled and restricted from the Brand forms,
 * this is controlled by an independent permission setting for
 * Administrators to delegate as necessary.
 *
 * @return array
 *   An array of theme names represented as the theme machine_name.
 */
function brand_get_allowed_themes() : array {
  $themes = list_themes();
  $configured_themes = variable_get('brand_allowed_themes', array());
  $results = array();
  foreach ((array) $configured_themes as $theme) {
    if (isset($themes[$theme])) {
      $results[] = $theme;
    }
  }
  return $results;
}

/**
 * Implements hook_views_api().
 *
 * @inheritdoc
 */
function brand_views_api() {
  return array(
    'api' => 3.0,
    'path' => drupal_get_path('module', 'brand') . '/lib/views',
  );
}

/**
 * Implements hook_views_pre_render().
 *
 * @inheritdoc
 */
function brand_views_pre_render(&$view) {
  // Let's make sure we're getting the right view.
  if ($view->base_table === 'brand') {
    // And, the correct display, as we only want to manipulate one.
    if ($view->current_display === 'all') {
      $newset = array();
      foreach ($view->result as $result) {
        $newset[$result->brand_machine_name] = $result;
      }
      $view->result = $newset;
    }
  }
}

/**
 * Implements hook_views_data().
 *
 * @inheritdoc
 */
function brand_views_data() {
  $table = array(
    'brand' => array(
      'table' => array(
        'group' => 'Brand',
        'base' => array(
          'field' => 'id',
          'title' => 'Brands',
          'help' => 'Table used for Brands',
        ),
      ),

      // Human readable name for the brand.
      'title' => array(
        'title' => t('Name'),
        'help' => t('The human-readable name for the brand.'),
        'field' => array(
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_string',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_string',
        ),
      ),

      // Machine name.
      'machine_name' => array(
        'title' => t('Machine name'),
        'help' => t('The machine name for the brand, which acts like a unique identifier.'),
        'field' => array(
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_string',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_string',
        ),
      ),

      // Date created.
      'date_created' => array(
        'title' => t('Date of creation'),
        'help' => t('The date each row was created.'),
        'field' => array(
          'handler' => 'views_handler_field_date',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_date',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
      ),

      // Date created.
      'date_start' => array(
        'title' => t('Date of start'),
        'help' => t('The date the brand logic allows it to start.'),
        'field' => array(
          'handler' => 'views_handler_field_date',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_date',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
      ),

      // Date created.
      'date_finish' => array(
        'title' => t('Date of finish'),
        'help' => t('The date the brand logic allows it to end.'),
        'field' => array(
          'handler' => 'views_handler_field_date',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_date',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
      ),

      // Visibility.
      'path_visibility' => array(
        'title' => t('Visibility'),
        'help' => t('The paths to select for this brand.'),
        'field' => array(
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_string',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_string',
        ),
      ),

      // Weight.
      'weight' => array(
        'title' => t('Weight'),
        'help' => t('The weight specified for this brand.'),
        'field' => array(
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_numeric',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_numeric',
        ),
      ),

      // Description.
      'description' => array(
        'title' => t('Description'),
        'help' => t('The message associated with this change.'),
        'field' => array(
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_string',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_string',
        ),
      ),

      // Date locking mechanism:
      'date_lock' => array(
        'title' => t('Date locking'),
        'help' => t('Determine if logic should prevent branding from finishing.'),
        'field' => array(
          'handler' => 'views_handler_field_boolean',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_boolean_operator',
          'label' => t('Does not expire?'),
          'type' => 'yes-no',
          'use equal' => TRUE,
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument',
        ),
      ),

      // Book:
      'bid' => array(
        'title' => t('Book'),
        'help' => t('The book selected for the entry for the brand.'),
        'field' => array(
          'handler' => 'brand_handler_bid',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_string',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_numeric',
        ),
      ),

      // Taxonomy:
      'tid' => array(
        'title' => t('Term'),
        'help' => t('The taxonomy term selected for the entry for the brand.'),
        'field' => array(
          'handler' => 'brand_handler_tid',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_string',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_numeric',
        ),
      ),

      // Role:
      'rid' => array(
        'title' => t('Role'),
        'help' => t('The user role selected for the entry for the brand.'),
        'field' => array(
          'handler' => 'views_handler_field_user_roles',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_user_roles',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_numeric',
        ),
      ),

      // User:
      'uid' => array(
        'title' => t('User'),
        'help' => t('The user that created the entry for the brand.'),
        'field' => array(
          'handler' => 'views_handler_field_user_name',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_user_name',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_numeric',
        ),
      ),

      // Vocabulary:
      'vid' => array(
        'title' => t('Vocabulary'),
        'help' => t('The vocabulary for the entry for the brand.'),
        'field' => array(
          'handler' => 'brand_handler_vid',
          'click sortable' => TRUE,
        ),
        'filter' => array(
          'handler' => 'views_handler_filter_string',
        ),
        'sort' => array(
          'handler' => 'views_handler_sort',
        ),
        'argument' => array(
          'handler' => 'views_handler_argument_numeric',
        ),
      ),

    ),
  );
  return $table;
}

/**
 * Implements hook_views_default_views().
 *
 * @inheritdoc
 */
function brand_views_default_views() {

  $view = new view();
  $view->name = 'brands';
  $view->description = '';
  $view->tag = 'default';
  $view->base_table = 'brand';
  $view->human_name = 'Brands';
  $view->core = 7;
  $view->api_version = '3.0';
  $view->disabled = FALSE; /* Edit this to true to make a default view disabled initially */

  /* Display: Master */
  $handler = $view->new_display('default', 'Master', 'default');
  $handler->display->display_options['title'] = 'Brands';
  $handler->display->display_options['use_more_always'] = FALSE;
  $handler->display->display_options['access']['type'] = 'perm';
  $handler->display->display_options['access']['perm'] = 'brand visibility';
  $handler->display->display_options['cache']['type'] = 'none';
  $handler->display->display_options['query']['type'] = 'views_query';
  $handler->display->display_options['exposed_form']['type'] = 'basic';
  $handler->display->display_options['pager']['type'] = 'none';
  $handler->display->display_options['style_plugin'] = 'table';
  /* Field: UNIX Timestamp */
  $handler->display->display_options['fields']['date_created_1']['id'] = 'date_created_1';
  $handler->display->display_options['fields']['date_created_1']['table'] = 'brand';
  $handler->display->display_options['fields']['date_created_1']['field'] = 'date_created';
  $handler->display->display_options['fields']['date_created_1']['ui_name'] = 'UNIX Timestamp';
  $handler->display->display_options['fields']['date_created_1']['label'] = '';
  $handler->display->display_options['fields']['date_created_1']['exclude'] = TRUE;
  $handler->display->display_options['fields']['date_created_1']['element_label_colon'] = FALSE;
  $handler->display->display_options['fields']['date_created_1']['date_format'] = 'custom';
  $handler->display->display_options['fields']['date_created_1']['custom_date_format'] = 'U';
  $handler->display->display_options['fields']['date_created_1']['second_date_format'] = 'rss';
  /* Field: Brand: Machine name */
  $handler->display->display_options['fields']['machine_name']['id'] = 'machine_name';
  $handler->display->display_options['fields']['machine_name']['table'] = 'brand';
  $handler->display->display_options['fields']['machine_name']['field'] = 'machine_name';
  $handler->display->display_options['fields']['machine_name']['label'] = '';
  $handler->display->display_options['fields']['machine_name']['exclude'] = TRUE;
  $handler->display->display_options['fields']['machine_name']['element_label_colon'] = FALSE;
  /* Field: Brand: Name */
  $handler->display->display_options['fields']['title']['id'] = 'title';
  $handler->display->display_options['fields']['title']['table'] = 'brand';
  $handler->display->display_options['fields']['title']['field'] = 'title';
  $handler->display->display_options['fields']['title']['alter']['alter_text'] = TRUE;
  $handler->display->display_options['fields']['title']['alter']['text'] = '[title]';
  $handler->display->display_options['fields']['title']['alter']['make_link'] = TRUE;
  $handler->display->display_options['fields']['title']['alter']['path'] = 'admin/config/user-interface/brands/[machine_name]';
  /* Field: Brand: Date of creation */
  $handler->display->display_options['fields']['date_created']['id'] = 'date_created';
  $handler->display->display_options['fields']['date_created']['table'] = 'brand';
  $handler->display->display_options['fields']['date_created']['field'] = 'date_created';
  $handler->display->display_options['fields']['date_created']['label'] = 'Updated';
  $handler->display->display_options['fields']['date_created']['date_format'] = 'short';
  $handler->display->display_options['fields']['date_created']['second_date_format'] = 'rss';
  /* Field: Brand: Date of start */
  $handler->display->display_options['fields']['date_start']['id'] = 'date_start';
  $handler->display->display_options['fields']['date_start']['table'] = 'brand';
  $handler->display->display_options['fields']['date_start']['field'] = 'date_start';
  $handler->display->display_options['fields']['date_start']['label'] = 'Starts';
  $handler->display->display_options['fields']['date_start']['date_format'] = 'short';
  $handler->display->display_options['fields']['date_start']['second_date_format'] = 'rss';
  /* Field: Brand: Date of finish */
  $handler->display->display_options['fields']['date_finish']['id'] = 'date_finish';
  $handler->display->display_options['fields']['date_finish']['table'] = 'brand';
  $handler->display->display_options['fields']['date_finish']['field'] = 'date_finish';
  $handler->display->display_options['fields']['date_finish']['label'] = 'Finishes';
  $handler->display->display_options['fields']['date_finish']['date_format'] = 'short';
  $handler->display->display_options['fields']['date_finish']['second_date_format'] = 'rss';
  /* Sort criterion: Brand: Date of creation */
  $handler->display->display_options['sorts']['date_created']['id'] = 'date_created';
  $handler->display->display_options['sorts']['date_created']['table'] = 'brand';
  $handler->display->display_options['sorts']['date_created']['field'] = 'date_created';

  /* Display: Page */
  $handler = $view->new_display('page', 'Page', 'all');
  $handler->display->display_options['defaults']['empty'] = FALSE;
  /* No results behavior: Global: Unfiltered text */
  $handler->display->display_options['empty']['area_text_custom']['id'] = 'area_text_custom';
  $handler->display->display_options['empty']['area_text_custom']['table'] = 'views';
  $handler->display->display_options['empty']['area_text_custom']['field'] = 'area_text_custom';
  $handler->display->display_options['empty']['area_text_custom']['empty'] = TRUE;
  $handler->display->display_options['empty']['area_text_custom']['content'] = '<p>Brands are small sub-themes which have specific logic to expose them during a given duration.</p>
<p>You can apply a brand using various components which make for good structural design, such as books, taxonomy terms or paths.</p>
<p>So why not create one using the link above?</p>';
  $handler->display->display_options['defaults']['fields'] = FALSE;
  /* Field: UNIX Timestamp */
  $handler->display->display_options['fields']['date_created_1']['id'] = 'date_created_1';
  $handler->display->display_options['fields']['date_created_1']['table'] = 'brand';
  $handler->display->display_options['fields']['date_created_1']['field'] = 'date_created';
  $handler->display->display_options['fields']['date_created_1']['ui_name'] = 'UNIX Timestamp';
  $handler->display->display_options['fields']['date_created_1']['label'] = '';
  $handler->display->display_options['fields']['date_created_1']['exclude'] = TRUE;
  $handler->display->display_options['fields']['date_created_1']['element_label_colon'] = FALSE;
  $handler->display->display_options['fields']['date_created_1']['date_format'] = 'custom';
  $handler->display->display_options['fields']['date_created_1']['custom_date_format'] = 'U';
  $handler->display->display_options['fields']['date_created_1']['second_date_format'] = 'rss';
  /* Field: Brand: Machine name */
  $handler->display->display_options['fields']['machine_name']['id'] = 'machine_name';
  $handler->display->display_options['fields']['machine_name']['table'] = 'brand';
  $handler->display->display_options['fields']['machine_name']['field'] = 'machine_name';
  $handler->display->display_options['fields']['machine_name']['label'] = '';
  $handler->display->display_options['fields']['machine_name']['exclude'] = TRUE;
  $handler->display->display_options['fields']['machine_name']['element_label_colon'] = FALSE;
  /* Field: Brand: Name */
  $handler->display->display_options['fields']['title']['id'] = 'title';
  $handler->display->display_options['fields']['title']['table'] = 'brand';
  $handler->display->display_options['fields']['title']['field'] = 'title';
  $handler->display->display_options['fields']['title']['alter']['alter_text'] = TRUE;
  $handler->display->display_options['fields']['title']['alter']['text'] = '[title]';
  $handler->display->display_options['fields']['title']['alter']['make_link'] = TRUE;
  $handler->display->display_options['fields']['title']['alter']['path'] = 'admin/config/user-interface/brands/[machine_name]';
  /* Field: Brand: Date of creation */
  $handler->display->display_options['fields']['date_created']['id'] = 'date_created';
  $handler->display->display_options['fields']['date_created']['table'] = 'brand';
  $handler->display->display_options['fields']['date_created']['field'] = 'date_created';
  $handler->display->display_options['fields']['date_created']['label'] = 'Updated';
  $handler->display->display_options['fields']['date_created']['date_format'] = 'short';
  $handler->display->display_options['fields']['date_created']['second_date_format'] = 'rss';
  /* Field: Brand: Description */
  $handler->display->display_options['fields']['description']['id'] = 'description';
  $handler->display->display_options['fields']['description']['table'] = 'brand';
  $handler->display->display_options['fields']['description']['field'] = 'description';
  $handler->display->display_options['fields']['description']['label'] = 'Message';
  $handler->display->display_options['path'] = 'admin/config/user-interface/brands';
  $handler->display->display_options['menu']['type'] = 'normal';
  $handler->display->display_options['menu']['title'] = 'Brands';
  $handler->display->display_options['menu']['description'] = 'Configuration page for brands';
  $handler->display->display_options['menu']['weight'] = '0';
  $handler->display->display_options['menu']['name'] = 'management';
  $handler->display->display_options['menu']['context'] = 0;
  $handler->display->display_options['menu']['context_only_inline'] = 0;

  /* Display: Page */
  $handler = $view->new_display('page', 'Page', 'specific');
  $handler->display->display_options['defaults']['fields'] = FALSE;
  /* Field: UNIX Timestamp */
  $handler->display->display_options['fields']['date_created_1']['id'] = 'date_created_1';
  $handler->display->display_options['fields']['date_created_1']['table'] = 'brand';
  $handler->display->display_options['fields']['date_created_1']['field'] = 'date_created';
  $handler->display->display_options['fields']['date_created_1']['ui_name'] = 'UNIX Timestamp';
  $handler->display->display_options['fields']['date_created_1']['label'] = '';
  $handler->display->display_options['fields']['date_created_1']['exclude'] = TRUE;
  $handler->display->display_options['fields']['date_created_1']['element_label_colon'] = FALSE;
  $handler->display->display_options['fields']['date_created_1']['date_format'] = 'custom';
  $handler->display->display_options['fields']['date_created_1']['custom_date_format'] = 'U';
  $handler->display->display_options['fields']['date_created_1']['second_date_format'] = 'rss';
  /* Field: Brand: Machine name */
  $handler->display->display_options['fields']['machine_name']['id'] = 'machine_name';
  $handler->display->display_options['fields']['machine_name']['table'] = 'brand';
  $handler->display->display_options['fields']['machine_name']['field'] = 'machine_name';
  $handler->display->display_options['fields']['machine_name']['label'] = '';
  $handler->display->display_options['fields']['machine_name']['exclude'] = TRUE;
  $handler->display->display_options['fields']['machine_name']['element_label_colon'] = FALSE;
  /* Field: Brand: Name */
  $handler->display->display_options['fields']['title']['id'] = 'title';
  $handler->display->display_options['fields']['title']['table'] = 'brand';
  $handler->display->display_options['fields']['title']['field'] = 'title';
  $handler->display->display_options['fields']['title']['alter']['alter_text'] = TRUE;
  $handler->display->display_options['fields']['title']['alter']['text'] = '[title]';
  $handler->display->display_options['fields']['title']['alter']['make_link'] = TRUE;
  $handler->display->display_options['fields']['title']['alter']['path'] = 'admin/config/user-interface/brands/[machine_name]/[date_created_1]';
  /* Field: Brand: Date of creation */
  $handler->display->display_options['fields']['date_created']['id'] = 'date_created';
  $handler->display->display_options['fields']['date_created']['table'] = 'brand';
  $handler->display->display_options['fields']['date_created']['field'] = 'date_created';
  $handler->display->display_options['fields']['date_created']['label'] = 'Date';
  $handler->display->display_options['fields']['date_created']['date_format'] = 'short';
  $handler->display->display_options['fields']['date_created']['second_date_format'] = 'rss';
  /* Field: Brand: Description */
  $handler->display->display_options['fields']['description']['id'] = 'description';
  $handler->display->display_options['fields']['description']['table'] = 'brand';
  $handler->display->display_options['fields']['description']['field'] = 'description';
  $handler->display->display_options['fields']['description']['label'] = 'Message';
  /* Field: Brand: User */
  $handler->display->display_options['fields']['uid']['id'] = 'uid';
  $handler->display->display_options['fields']['uid']['table'] = 'brand';
  $handler->display->display_options['fields']['uid']['field'] = 'uid';
  $handler->display->display_options['fields']['uid']['label'] = 'Credit';
  $handler->display->display_options['fields']['uid']['exclude'] = TRUE;
  $handler->display->display_options['defaults']['arguments'] = FALSE;
  /* Contextual filter: Brand: Machine name */
  $handler->display->display_options['arguments']['machine_name']['id'] = 'machine_name';
  $handler->display->display_options['arguments']['machine_name']['table'] = 'brand';
  $handler->display->display_options['arguments']['machine_name']['field'] = 'machine_name';
  $handler->display->display_options['arguments']['machine_name']['default_action'] = 'not found';
  $handler->display->display_options['arguments']['machine_name']['exception']['value'] = '';
  $handler->display->display_options['arguments']['machine_name']['default_argument_type'] = 'raw';
  $handler->display->display_options['arguments']['machine_name']['default_argument_options']['index'] = '4';
  $handler->display->display_options['arguments']['machine_name']['summary']['number_of_records'] = '0';
  $handler->display->display_options['arguments']['machine_name']['summary']['format'] = 'default_summary';
  $handler->display->display_options['arguments']['machine_name']['summary_options']['items_per_page'] = '25';
  $handler->display->display_options['arguments']['machine_name']['limit'] = '0';
  $handler->display->display_options['path'] = 'admin/config/user-interface/brands/%';
  $handler->display->display_options['menu']['title'] = 'Brand dashboard';
  $handler->display->display_options['menu']['weight'] = '0';
  $handler->display->display_options['menu']['context'] = 0;
  $handler->display->display_options['menu']['context_only_inline'] = 0;

  $views[$view->name] = $view;
  return $views;
}

/**
 * Get an associative array of terms.
 *
 * @param int $vid
 *   The optional vocabulary ID to choose.
 *
 * @return array
 *   An associative array of terms.
 */
function brand_form_get_terms($vid = NULL) {
  // Get and store a key => value strucured array with
  // the VID containing the term name and term id.
  $vocabularies = taxonomy_get_vocabularies();
  $results = array();
  foreach ((array) $vocabularies as $vocabulary) {
    $terms = taxonomy_get_tree($vocabulary->vid);
    foreach ($terms as $term) {
      $results[$vocabulary->vid][0] = 'Not selected';
      $results[$vocabulary->vid][$term->tid] = $term->name;
    }
  }
  if (!empty($results)) {
    if (NULL !== $vid && (int) $vid > 0) {
      return $results[$vid];
    }
    return $results;
  }
  else {
    return array();
  }
}

/**
 * Change the available taxonomy terms after changing the vocabulary.
 *
 * @param array $form
 *   The form array.
 * @param array $form_state
 *   The form state array.
 *
 * @return string
 *   The rendered form component for the term component.
 */
function brand_form_vocabulary_callback($form, &$form_state) {
  $arguments = explode('/', $_GET['q']);
  $all_terms = brand_form_get_terms();
  $selectable_terms = $all_terms[$form_state['input']['vocabulary']];
  if ((int) $form_state['input']['vocabulary'] > 0) {
    $form['taxonomy']['term']['#options'] = $selectable_terms;
    form_set_value($form['taxonomy']['term'], '0', $form_state);
  }
  else {
    form_set_value($form['taxonomy']['term'], '0', $form_state);
    $form['taxonomy']['term']['#options'] = array(
      0 => 'Vocabulary not selected.',
    );
  }
  $form_state['rebuild'] = TRUE;
  return render($form['taxonomy']['term']);
}

/**
 * Cancel button for form.
 */
function brand_form_cancel() {
  $arguments = explode('/', $_GET['q']);
  $machine_name = $arguments[4];
  if (is_numeric((int) $arguments[5])) {
    $timestamp = (int) $arguments[5];
  }
  if (isset($timestamp) && isset($machine_name)) {
    drupal_goto("/admin/config/user-interface/brands/{$machine_name}/");
  }
  elseif (isset($machine_name)) {
    drupal_goto("/admin/config/user-interface/brands/");
  }
}

/**
 * Returns a standardized $form object.
 *
 * To be used as a parameter to array_merge().
 * This may or may not include options , values
 * or default values for each field.
 */
function brand_get_universal_form() {
  $form = array();
  $theme_restrictions = (int) variable_get('brand_disable_checking', 0);
  if ($theme_restrictions === 1) {
    $all_themes = list_themes();
    $themes = array(
      'none' => 'None selected',
    );
    foreach ($all_themes as $name => $theme) {
      if ((int) $theme->status === 1) {
        $themes[$name] = $name;
      }
    }
  } else if ($theme_restrictions === 0) {
    $all_themes = brand_get_allowed_themes();
    $drupal_themes = list_themes();
    $themes = array(
      'none' => 'None selected',
    );
    foreach ($all_themes as $name => $theme) {
      if ((int) $drupal_themes[$theme]->status === 1) {
        $themes[$theme] = $theme;
      }
    }
  }

  if (module_exists('book')) {
    $book_raw = book_get_books();
    $books = array(
      0 => 'None',
    );
    foreach ($book_raw as $key => $value) {
      $books[$key] = $book_raw[$key]['title'];
    }
  }

  if (module_exists('taxonomy')) {
    $vocabs = taxonomy_get_vocabularies();
    $vocabularies = array(
      0 => 'Not selected',
    );
    foreach ((array) $vocabs as $vocabulary) {
      $vocabularies[$vocabulary->vid] = $vocabulary->name;
    }
  }

  /* Declare the vertical tab groups. */

  $form['vtabs'] = array(
    '#type' => 'vertical_tabs',
  );

  $form['basic'] = array(
    '#type' => 'fieldset',
    '#title' => t('General'),
    '#group' => 'vtabs',
  );

  $form['assets'] = array(
    '#type' => 'fieldset',
    '#title' => t('Assets'),
    '#group' => 'vtabs',
  );

  $form['dates'] = array(
    '#type' => 'fieldset',
    '#title' => t('Dates'),
    '#group' => 'vtabs',
  );

  if (module_exists('book')) {
    $form['book'] = array(
      '#type' => 'fieldset',
      '#title' => t('Book'),
      '#group' => 'vtabs',
    );
  }

  $form['role'] = array(
    '#type' => 'fieldset',
    '#title' => t('Role'),
    '#group' => 'vtabs',
  );

  if (module_exists('taxonomy')) {
    $form['taxonomy'] = array(
      '#type' => 'fieldset',
      '#title' => t('Taxonomy'),
      '#group' => 'vtabs',
    );
  }

  $form['visibility'] = array(
    '#type' => 'fieldset',
    '#title' => t('Visibility'),
    '#group' => 'vtabs',
  );

  /* Declare fields. */

  $form['basic']['title'] = array(
    '#type' => 'textfield',
    '#title' => t('Branding name'),
    '#description' => t("This is the human-readable name associated to the brand.<br />It's only used on administration pages to identify the brand."),
    '#size' => 60,
    '#maxlength' => 128,
    '#required' => TRUE,
  );

  $form['basic']['machine_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Machine name'),
    '#description' => t('The name which Drupal will associate to this brand.<br />This value must be unique, as it is used to discover if the brand should be displayed and to show information in the administration pages.'),
    '#size' => 60,
    '#maxlength' => 128,
    '#required' => TRUE,
  );

  $form['basic']['description'] = array(
    '#type' => 'textarea',
    '#title' => t('Description'),
    '#description' => t('The message associated to this change, which could include details about what changed, who asked for the changes and why the changes are occuring.'),
    '#rows' => 5,
    '#cols' => 5,
    '#maxlength' => 500,
    '#wysiwyg' => FALSE,
    '#format' => 'plain_text',
    '#required' => TRUE,
  );

  $restriction = variable_get('brand_disable_checking', 0);
  if ((int) $restriction === 0) {
    $form['assets']['theme_description'] = array(
      '#type' => 'markup',
      '#markup' => '<p>If the desired theme, or no theme is available, please contact your administrator to either open up access to specific themes or to remove restrictions based upon the themes you are allowed to choose. Any selected themes will cease to work in the event your administrator imposes changes which deem the selected theme to be unavailable.</p><p>In addition to this, the list of available themes are also limited to enabled themes - you may wish to speak to your administrator about this in the event you cannot find the theme you need.</p>',
    );
  }
  else {
    $form['assets']['theme_description'] = array(
      '#type' => 'markup',
      '#markup' => '<p>Your administrator has not imposed theme-specific restrictions to the brand module for this website. The list of available themes is only limited to enabled themes - you may wish to speak to your administrator about this in the event you cannot find the theme you need.</p>',
    );
  }

  $form['assets']['theme'] = array(
    '#type' => 'select',
    '#title' => 'Theme',
    '#description' => t('Which theme do you wish to associate to this brand?'),
    '#required' => FALSE,
    '#default_value' => 'none',
    '#options' => $themes,
  );

  $form['assets']['weight'] = array(
    '#type' => 'select',
    '#title' => 'Weight',
    '#description' => t('Specify a weight, which will be used to determine if a particular brand should rule out including conflicting brands.'),
    '#required' => FALSE,
  );
  $options = array();
  for ($i = -20; $i <= 20; $i++) {
    $options[(int) $i] = $i;
  };
  $form['assets']['weight']['#options'] = $options;
  $form['assets']['weight']['#default_value'] = 0;

  $date = new DateTime();
  $now = $date->getTimestamp();

  $form['dates']['date_created'] = array(
    '#type' => 'textfield',
    '#title' => t('Creation date'),
    '#description' => t('The timestamp associated to this entry, be it the first entry of a new brand or any subsequent changes.<br />This value represents the timestamp for when this form was generated.'),
    '#required' => TRUE,
    '#disabled' => TRUE,
    '#access' => FALSE,
    '#default_value' => $now,
  );

  $form['dates']['date_start'] = array(
    '#type' => 'date',
    '#title' => t('Start date'),
    '#description' => t('The date in which this brand will become available.<br /><strong>Note</strong>: This will be used in the UNIX timestamp format based upon the configured server time.<br /><strong>Note</strong>: Caches could still prevent the change from happening when expected.'),
    '#required' => TRUE,
  );

  $form['dates']['date_finish'] = array(
    '#type' => 'date',
    '#title' => t('Finish date'),
    '#description' => t('The date in which this brand will stop being available.<br /><strong>Note</strong>: This will be used in the UNIX timestamp format based upon the configured server time.<br /><strong>Note</strong>: Caches could still prevent the change from happening when expected.'),
    '#required' => TRUE,
  );

  $form['dates']['date_lock'] = array(
    '#type' => 'checkbox',
    '#title' => 'Prevent brand expiration',
    '#description' => t('Instead of stopping the availability of a brand, you can continue it indefinitely (until configured otherwise) by checking this option.'),
  );

  if (module_exists('book')) {
    $form['book']['bid'] = array(
      '#type' => 'select',
      '#title' => t('Book'),
      '#description' => t('Apply the branding to a given book - which will change the theme on every page in the book outline.'),
      '#options' => $books,
    );
  }

  $form['role']['rid'] = array(
    '#type' => 'select',
    '#title' => 'User access',
    '#description' => t('Allow the brand to show for the given user role (anonymous or otherwise).'),
    '#options' => user_roles(),
  );

  if (module_exists('taxonomy')) {
    $form['taxonomy']['vocabulary'] = array(
      '#type' => 'select',
      '#title' => 'Select a taxonomy',
      '#description' => t('Choose a vocabulary to filter the term selection input.<br />Choosing a vocabulary has no bearing on the validation checkers which control the display/logic of a brand.'),
      '#options' => $vocabularies,
      '#ajax' => array(
        'callback' => 'brand_form_vocabulary_callback',
        'wrapper' => 'view-display-dropdown',
      ),
    );

    $form['taxonomy']['term'] = array(
      '#type' => 'select',
      '#title' => 'Term',
      '#description' => t('Apply the branding to all content tagged with this term.'),
      '#prefix' => '<div id="view-display-dropdown">',
      '#suffix' => '</div>',
      '#options' => array(
        0 => 'Not selected',
      ),
    );
  }

  $form['visibility']['paths'] = array(
    '#type' => 'textarea',
    '#title' => t('Paths'),
    '#description' => t('Manually enter one or more paths (optionally using globs) to show the branding on.<br /><br />Example:<br /><br />node/1<br />node/2<br />resources/*'),
    '#size' => 60,
    '#maxlength' => 500,
    '#wysiwyg' => TRUE,
    '#format' => 'full_html',
  );

  $form['submit_button'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );

  $form['cancel_button'] = array(
    '#type' => 'submit',
    '#value' => t('Cancel'),
    '#submit' => array('brand_form_cancel'),
    '#limit_validation_errors' => array(),
  );

  $form['#pre_render'][] = 'vertical_tabs_form_pre_render';

  return $form;
}
