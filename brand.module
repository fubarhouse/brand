<?php

function get_machine_name() : array {
    $results = [];
    $brands = new Brands(NULL, TRUE);
    foreach ($brands::$Brands as $brand) {
        if ($node = menu_get_object()) {

            // Book.
            if (module_exists('book')) {
                if (isset($node->book['bid'])) {
                    if ((int) $node->book['bid'] === (int) $brand->bid) {
                        $results[$brand->machine_name] = $brand->machine_name;
                    }
                }
            }

            // Nodes.
            if (module_exists('node')) {
                $delimiter = preg_split('/\s+/', $brand->path_visibility);
                foreach ($delimiter as $node_target) {

                    // Look for "node/xxx" in the path_visibility field:
                    if ($node = menu_get_object()) {
                        if (strpos($node_target, 'node/' . $node->nid) !== FALSE) {
                            $results[$brand->machine_name] = $brand->machine_name;
                        }
                    }

                    // Check if the current node alias is the node target.
                    if ($node_target === current_path()) {
                        $results[$brand->machine_name] = $brand->machine_name;
                    }

                    // Check if the current node path matches the node target.
                    if (drupal_match_path(current_path(), $node_target)) {
                        $results[$brand->machine_name] = $brand->machine_name;
                    }

                    // Check if the current node alias matches the node target.
                    if (drupal_match_path(drupal_get_path_alias(), $node_target)) {
                        $results[$brand->machine_name] = $brand->machine_name;
                    }
                }
            }

            // Taxonomy.
            if (module_exists('taxonomy')) {
                foreach ((array) field_info_instances('node', $node->type) as $field_name => $info) {
                    foreach ((array) field_get_items('node', $node, $field_name) as $item) {
                        if (is_array($item) && !empty($item['tid']) && $brand->tid = taxonomy_term_load($item['tid'])) {
                            $results[$brand->machine_name] = $brand->machine_name;
                        }
                    }
                }
            }
        }

        // Paths.
        $delimiter = preg_split('/\s+/', $brand->path_visibility);
        foreach ($delimiter as $path_target) {
            if (!empty(trim($path_target))) {
                if (isset($_GET['destination']) && drupal_match_path($_GET['destination'], $path_target)) {
                    $results[$brand->machine_name] = $brand->machine_name;
                } elseif (isset($_GET['q']) && drupal_match_path($_GET['q'], $path_target)) {
                    $results[$brand->machine_name] = $brand->machine_name;
                }
            }
        }
    }
    return $results;
}

/**
 * hook_brand_alter
 *
 * @inheritdoc
 */
function validation_brand_alter(&$variables) {

    $variables['machine_name'] = 'hhhddd';

}

/**
 * Implements hook_preprocess_html().
 *
 * @inheritdoc
 */
function brand_preprocess_html(&$variables) {
    $machine_names = get_machine_name();
    foreach ($machine_names as $machine_name) {
        $brand = new Brand($machine_name);
        $variables['brand'][] = $brand::$Brand;
    }

//    die();
}

/**
 * Implements hook_preprocess_page().
 *
 * @inheritdoc
 */
function brand_preprocess_page(&$variables) {
    $machine_names = get_machine_name();
    foreach ($machine_names as $machine_name) {
        $brand = new Brand($machine_name);
        $variables['brand'][] = $brand::$Brand;
    }
}

/**
 * Implements hook_preprocess_node().
 *
 * @inheritdoc
 */
function brand_preprocess_node(&$variables) {
    $machine_names = get_machine_name();
    foreach ($machine_names as $machine_name) {
        $brand = new Brand($machine_name);
        $variables['brand'][] = $brand::$Brand;
    }
}

/**
 * Implements hook_init().
 *
 * @inheritdoc
 */
function brand_init() {
    module_load_include('inc', 'brand', 'inc/form_add');
    module_load_include('inc', 'brand', 'inc/menu');
}
